name: Deploy to Hostinger

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v2

      - name: 🔐 Set up SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 📡 Add Host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: 🔌 Test SSH Connection
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "echo ✅ SSH connected."

      - name: 🚀 Deploy to Hostinger via SSH
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            cd ${{ secrets.PROJECT_PATH }}

            echo "🛠 Putting app in maintenance mode..."
            php artisan down || true

            echo "🔄 Pulling latest changes from Git..."
            git pull origin master

            echo "📦 Checking if composer install is needed..."
            CHANGED=false
            if [ ! -d "vendor" ]; then
              CHANGED=true
            elif [ composer.lock -nt vendor ]; then
              CHANGED=true
            fi

            if [ "$CHANGED" = true ]; then
              echo "📦 Installing composer dependencies..."
              composer2 install --no-interaction --prefer-dist --optimize-autoloader
            else
              echo "✅ Skipping composer install - no changes."
            fi

            echo "🗄 Checking for pending migrations..."
            OUTDATED=$(php artisan migrate:status | grep -c '| N ')
            if [ "$OUTDATED" -gt 0 ]; then
              echo "🗄 Running migrations..."
              php artisan migrate --force --verbose
            else
              echo "✅ No pending migrations."
            fi

            echo "🧹 Clearing and caching..."
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear

            echo "🚀 Optimizing..."
            php artisan optimize

            echo "🔓 App back online..."
            php artisan up

            echo "✅ Deployment complete."
          EOF
